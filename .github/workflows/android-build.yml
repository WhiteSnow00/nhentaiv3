name: Build Android APK

on:
  push:
    branches: [ "**" ]
  pull_request:
  workflow_dispatch:

concurrency:
  group: android-apk-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Grant execute permission for Gradle wrapper
        run: chmod +x ./gradlew

      - name: Gradle build (Post28 Debug)
        run: ./gradlew --no-daemon --stacktrace assemblePost28Debug

      - name: Gradle lint (Post28 Debug)
        run: ./gradlew --no-daemon --stacktrace lintPost28Debug

      - name: Detect signing secrets
        id: signing
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          if [ -n "$ANDROID_KEYSTORE_BASE64" ]; then
            echo "available=true" >> "$GITHUB_OUTPUT"
          else
            echo "available=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Decode keystore (only when signing is available)
        if: ${{ steps.signing.outputs.available == 'true' }}
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > /tmp/keystore.jks

      - name: Gradle build (Release - signed)
        if: ${{ steps.signing.outputs.available == 'true' }}
        env:
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          ./gradlew --no-daemon --stacktrace assemblePost28Release \
            -Pandroid.injected.signing.store.file=/tmp/keystore.jks \
            -Pandroid.injected.signing.store.password="$ANDROID_KEYSTORE_PASSWORD" \
            -Pandroid.injected.signing.key.alias="$ANDROID_KEY_ALIAS" \
            -Pandroid.injected.signing.key.password="$ANDROID_KEY_PASSWORD"


      - name: Gradle build (Post28 Release - unsigned)
        if: ${{ steps.signing.outputs.available != 'true' }}
        run: ./gradlew --no-daemon --stacktrace assemblePost28Release

      - name: Collect APKs
        run: |
          mkdir -p artifacts
          find . -type f -path "*build/outputs/apk*/*.apk" -print -exec cp -v {} artifacts/ \;
          ls -lah artifacts

      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: apks-${{ github.sha }}
          path: artifacts/*.apk
          if-no-files-found: error
